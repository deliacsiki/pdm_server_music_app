{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/auth/index.js","webpack:///./src/auth/router.js","webpack:///./src/auth/store.js","webpack:///./src/index.js","webpack:///./src/songs/index.js","webpack:///./src/songs/router.js","webpack:///./src/songs/store.js","webpack:///./src/songs/validator.js","webpack:///./src/utils/constants.js","webpack:///./src/utils/index.js","webpack:///./src/utils/middlewares.js","webpack:///./src/utils/wss.js","webpack:///external \"@koa/cors\"","webpack:///external \"http\"","webpack:///external \"jsonwebtoken\"","webpack:///external \"koa\"","webpack:///external \"koa-bodyparser\"","webpack:///external \"koa-jwt\"","webpack:///external \"koa-router\"","webpack:///external \"nedb-promise\"","webpack:///external \"ws\""],"names":["router","Router","createToken","user","jwt","sign","username","_id","jwtConfig","secret","expiresIn","createUser","response","userStore","insert","body","token","status","err","issue","error","message","post","ctx","request","credentials","findOne","password","UserStore","constructor","filename","autoload","store","dataStore","props","app","Koa","server","http","createServer","callback","wss","WebSocket","Server","initWss","use","cors","timingLogger","exceptionHandler","bodyParser","prefix","publicApiRouter","authRouter","routes","allowedMethods","protectedApiRouter","songRouter","listen","console","log","get","userId","state","page","query","rightLimit","leftLimit","Object","values","songStore","find","filter","_","i","note","params","id","createSong","song","broadcast","type","payload","put","songId","updatedCount","update","del","remove","SongStore","validator","SongValidator","validationResults","validate","hasError","Error","setSong","validation","songValid","name","artist","releaseDate","Date","parse","downloaded","next","start","now","method","url","value","on","ws","JSON","close","verify","data","clients","forEach","client","readyState","OPEN","send","stringify"],"mappings":"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","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 0);\n","export * from './router';","import Router from 'koa-router';\r\nimport userStore from './store';\r\nimport jwt from 'jsonwebtoken';\r\nimport { jwtConfig } from '../utils';\r\n\r\nexport const router = new Router();\r\n\r\nconst createToken = (user) => {\r\n  return jwt.sign({ username: user.username, _id: user._id }, jwtConfig.secret, { expiresIn: 60 * 60 * 60 });\r\n};\r\n\r\nconst createUser = async (user, response) => {\r\n  try {\r\n    await userStore.insert(user);\r\n    response.body = { token: createToken(user) };\r\n    response.status = 201; // created\r\n  } catch (err) {\r\n    response.body = { issue: [{ error: err.message }] };\r\n    response.status = 400; // bad request\r\n  }\r\n};\r\n\r\nrouter.post('/signup', async (ctx) => await createUser(ctx.request.body, ctx.response));\r\n\r\nrouter.post('/login', async (ctx) => {\r\n  const credentials = ctx.request.body;\r\n  const response = ctx.response;\r\n  const user = await userStore.findOne({ username: credentials.username });\r\n  if (user && credentials.password === user.password) {\r\n    response.body = { token: createToken(user), _id: user._id };\r\n    response.status = 201; // created\r\n  } else {\r\n    response.body = { issue: [{ error: 'Invalid credentials' }] };\r\n    response.status = 400; // bad request\r\n  }\r\n});\r\n","import dataStore from 'nedb-promise';\r\n\r\nexport class UserStore {\r\n  constructor({ filename, autoload }) {\r\n    this.store = dataStore({ filename, autoload });\r\n  }\r\n  \r\n  async findOne(props) {\r\n    return this.store.findOne(props);\r\n  }\r\n  \r\n  async insert(user) {\r\n    //\r\n    return this.store.insert(user);\r\n  };\r\n}\r\n\r\nexport default new UserStore({ filename: './db/users.json', autoload: true });","import Koa from 'koa';\r\nimport WebSocket from 'ws';\r\nimport http from 'http';\r\nimport Router from 'koa-router';\r\nimport bodyParser from \"koa-bodyparser\";\r\nimport { timingLogger, exceptionHandler, jwtConfig, initWss, verifyClient } from './utils';\r\nimport { router as songRouter } from './songs';\r\nimport { router as authRouter } from './auth';\r\nimport jwt from 'koa-jwt';\r\nimport cors from '@koa/cors';\r\n\r\nconst app = new Koa();\r\nconst server = http.createServer(app.callback());\r\nconst wss = new WebSocket.Server({ server });\r\ninitWss(wss);\r\n\r\napp.use(cors());\r\napp.use(timingLogger);\r\napp.use(exceptionHandler);\r\napp.use(bodyParser());\r\n\r\nconst prefix = '/api';\r\n\r\n// public\r\nconst publicApiRouter = new Router({ prefix });\r\npublicApiRouter.use('/auth', authRouter.routes());\r\napp\r\n  .use(publicApiRouter.routes())\r\n  .use(publicApiRouter.allowedMethods());\r\n\r\napp.use(jwt(jwtConfig));\r\n\r\n// protected\r\nconst protectedApiRouter = new Router({ prefix });\r\nprotectedApiRouter.use('/song', songRouter.routes());\r\napp\r\n  .use(protectedApiRouter.routes())\r\n  .use(protectedApiRouter.allowedMethods());\r\n\r\nserver.listen(3001);\r\nconsole.log('Server started on port 3001');\r\n","export * from './router';","import Router from 'koa-router';\r\nimport songStore from './store';\r\nimport { broadcast } from \"../utils\";\r\n\r\nexport const router = new Router();\r\n\r\nrouter.get('/', async (ctx) => {\r\n  const response = ctx.response;\r\n  const userId = ctx.state.user._id;\r\n  const page = ctx.query.page;\r\n  if (page){\r\n    const rightLimit = 3 * page;\r\n    const leftLimit = rightLimit - 3;\r\n    response.body = Object.values(await songStore.find({ userId })).filter((_, i) => i < rightLimit && i >= leftLimit);\r\n  }\r\n  else{  \r\n    response.body = await songStore.find({ userId });\r\n  }\r\n  \r\n  response.status = 200; // ok\r\n});\r\n\r\nrouter.get('/:id', async (ctx) => {\r\n  const userId = ctx.state.user._id;\r\n  const note = await songStore.findOne({ _id: ctx.params.id });\r\n  const response = ctx.response;\r\n  if (note) {\r\n    if (note.userId === userId) {\r\n      response.body = note;\r\n      response.status = 200; // ok\r\n    } else {\r\n      response.status = 403; // forbidden\r\n    }\r\n  } else {\r\n    response.status = 404; // not found\r\n  }\r\n});\r\n\r\nconst createSong = async (ctx, song, response) => {\r\n  try {\r\n    const userId = ctx.state.user._id;\r\n    song.userId = userId;\r\n    response.body = await songStore.insert(song);\r\n    console.log(response.body);\r\n    response.status = 201; // created\r\n    broadcast(userId, { type: 'created', payload: song });\r\n  } catch (err) {\r\n    response.body = { message: err.message };\r\n    response.status = 400; // bad request\r\n  }\r\n};\r\n\r\nrouter.post('/', async ctx => await createSong(ctx, ctx.request.body, ctx.response));\r\n\r\nrouter.put('/:id', async (ctx) => {\r\n  const song = ctx.request.body;\r\n  const id = ctx.params.id;\r\n  const songId = song._id;\r\n  const response = ctx.response;\r\n  if (songId && songId !== id) {\r\n    response.body = { message: 'Param id and body _id should be the same' };\r\n    response.status = 400; // bad request\r\n    return;\r\n  }\r\n  if (!songId) {\r\n    await createSong(ctx, song, response);\r\n  } else {\r\n    const userId = ctx.state.user._id;\r\n    song.userId = userId;\r\n    const updatedCount = await songStore.update({ _id: id }, song);\r\n    if (updatedCount === 1) {\r\n      response.body = song;\r\n      response.status = 200; // ok\r\n      broadcast(userId, { type: 'updated', payload: song });\r\n    } else {\r\n      response.body = { message: 'Resource no longer exists' };\r\n      response.status = 405; // method not allowed\r\n    }\r\n  }\r\n});\r\n\r\nrouter.del('/:id', async (ctx) => {\r\n  const userId = ctx.state.user._id;\r\n  const note = await songStore.findOne({ _id: ctx.params.id });\r\n  if (note && userId !== note.userId) {\r\n    ctx.response.status = 403; // forbidden\r\n  } else {\r\n    await songStore.remove({ _id: ctx.params.id });\r\n    ctx.response.status = 204; // no content\r\n  }\r\n});\r\n","import dataStore from 'nedb-promise';\r\nimport SongValidator from './validator';\r\n\r\nexport class SongStore {\r\n  constructor({ filename, autoload }) {\r\n    this.store = dataStore({ filename, autoload });\r\n    this.validator = new SongValidator();\r\n  }\r\n  \r\n  async find(props) {\r\n    return this.store.find(props);\r\n  }\r\n  \r\n  async findOne(props) {\r\n    return this.store.findOne(props);\r\n  }\r\n  \r\n  async insert(song) {\r\n    const validationResults = this.validator.validate(song);\r\n    if(validationResults.hasError){\r\n      console.log(\"[Validation error]: \", validationResults.message);\r\n      throw new Error(validationResults.message);\r\n    }\r\n    return this.store.insert(validationResults.song);\r\n  };\r\n  \r\n  async update(props, note) {\r\n    return this.store.update(props, note);\r\n  }\r\n  \r\n  async remove(props) {\r\n    return this.store.remove(props);\r\n  }\r\n}\r\n\r\nexport default new SongStore({ filename: './db/songs.json', autoload: true });","\r\nexport class SongValidator {\r\n    constructor() {\r\n        this.song = null;\r\n    }\r\n\r\n    setSong({song}){\r\n        this.song = song;\r\n    }\r\n\r\n    validate(song){\r\n        let validation = { hasError: false, message: null, song: null };\r\n        const songValid = {...song};\r\n      \r\n        if (song.name === \"\") {\r\n          validation.hasError = true;\r\n          validation.message = \"Song name is empty!\";\r\n        }\r\n        else songValid.name = song.name;\r\n      \r\n        if (song.artist === \"\") {\r\n          validation.hasError = true;\r\n          validation.message = \"Artist name is empty!\";\r\n        }\r\n        else songValid.artist = song.artist;\r\n      \r\n        if (song.releaseDate === \"\") {\r\n          validation.hasError = true;\r\n          validation.message = \"Release date is not a valid date!\";\r\n        }\r\n        else songValid.releaseDate = new Date(Date.parse(song.releaseDate));\r\n      \r\n        if (song.downloaded === \"\") {\r\n          validation.hasError = true;\r\n          validation.message = \"Downloaded field is empty!\";\r\n        }\r\n        else songValid.downloaded = song.downloaded;\r\n      \r\n        validation.song = songValid;\r\n        return validation;\r\n      }\r\n}\r\n\r\nexport default SongValidator;","export const jwtConfig = { secret: 'my-secret' };\r\n","export * from './constants';\r\nexport * from './middlewares';\r\nexport * from './wss';\r\n","export const exceptionHandler = async (ctx, next) => {\r\n  try {\r\n    return await next();\r\n  } catch (err) {\r\n    ctx.body = { message: err.message || 'Unexpected error.' };\r\n    ctx.status = err.status || 500;\r\n  }\r\n};\r\n\r\nexport const timingLogger = async (ctx, next) => {\r\n  const start = Date.now();\r\n  await next();\r\n  console.log(`${ctx.method} ${ctx.url} => ${ctx.response.status}, ${Date.now() - start}ms`);\r\n};\r\n","import WebSocket from \"ws\";\r\nimport jwt from \"jsonwebtoken\";\r\nimport { jwtConfig } from \"./constants\";\r\n\r\nlet wss;\r\n\r\nexport const initWss = value => {\r\n  wss = value;\r\n  wss.on('connection', ws => {\r\n    ws.on('message', message => {\r\n      const { type, payload: { token } } = JSON.parse(message);\r\n      if (type !== 'authorization') {\r\n        ws.close();\r\n        return;\r\n      }\r\n      try {\r\n        ws.user = jwt.verify(token, jwtConfig.secret);\r\n      } catch (err) {\r\n        ws.close();\r\n      }\r\n    })\r\n  });\r\n};\r\n\r\nexport const broadcast = (userId, data) => {\r\n  if (!wss) {\r\n    return;\r\n  }\r\n  wss.clients.forEach(client => {\r\n    if (client.readyState === WebSocket.OPEN && userId === client.user._id) {\r\n      console.log(`broadcast sent to ${client.user.username}`);\r\n      client.send(JSON.stringify(data));\r\n    }\r\n  });\r\n};\r\n","module.exports = require(\"@koa/cors\");","module.exports = require(\"http\");","module.exports = require(\"jsonwebtoken\");","module.exports = require(\"koa\");","module.exports = require(\"koa-bodyparser\");","module.exports = require(\"koa-jwt\");","module.exports = require(\"koa-router\");","module.exports = require(\"nedb-promise\");","module.exports = require(\"ws\");"],"sourceRoot":""}